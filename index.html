<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Resultados de Opera√ß√£o - 2¬™ Cia</title>
  <style>
    :root{
      --amarelo:#FFFF00;
      --amarelo-neon:#f9ff7a;
      --cinza:#ccc;
      --cinza-medio:#777;
      --bg:#000;
      --card-bg:rgba(10,10,15,0.96);
      --radius:14px;
      --shadow-soft:0 14px 40px rgba(0,0,0,0.8);
    }

    *{box-sizing:border-box;margin:0;padding:0;}

    body{
      min-height:100vh;
      background: radial-gradient(circle at top, #202020 0, #050509 48%, #000 100%);
      font-family: Arial, Helvetica, sans-serif;
      color: var(--amarelo);
      display: flex;
      justify-content: center;
      align-items: flex-start;
      padding: 20px 8px 32px;
    }

    .shell{
      width:100%;
      max-width:1200px;
      background: radial-gradient(circle at top, #1c1c1c 0, #050509 55%, #000 100%);
      border-radius:22px;
      border:1px solid #444;
      padding:18px 14px 24px;
      box-shadow:0 0 28px rgba(0,0,0,0.95);
      position:relative;
      overflow:hidden;
    }

    .shell::before{
      content:"";
      position:absolute;
      inset:-80px;
      background:
        radial-gradient(circle at 0 0, rgba(255,255,0,0.16), transparent 55%),
        radial-gradient(circle at 100% 0, rgba(255,255,0,0.12), transparent 50%);
      opacity:0.9;
      pointer-events:none;
    }

    .shell-inner{ position:relative; z-index:1; }

    header{
      display:flex;
      flex-wrap:wrap;
      align-items:flex-start;
      justify-content:space-between;
      margin-bottom:12px;
      padding-bottom:10px;
      border-bottom:1px solid rgba(255,255,255,0.08);
      gap:4px;
    }

    .titulo{
      font-size:1.35rem;
      font-weight:700;
      text-shadow:0 0 8px rgba(255,255,0,0.55);
      text-transform:uppercase;
    }

    .subtitulo{
      font-size:0.84rem;
      color:var(--cinza);
      text-transform:uppercase;
      letter-spacing:0.13em;
    }

    .badge{
      font-size:0.74rem;
      padding:4px 10px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,0.22);
      color:var(--cinza);
      margin-top:4px;
    }

    .tabs-top{
      display:flex;
      gap:8px;
      margin-bottom:14px;
      flex-wrap:wrap;
    }

    .tab-btn{
      flex:1 1 160px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,0.18);
      background:radial-gradient(circle at top, rgba(255,255,255,0.06), rgba(0,0,0,0.88));
      padding:10px 14px;
      text-transform:uppercase;
      letter-spacing:0.15em;
      cursor:pointer;
      color:var(--cinza);
      display:flex;
      justify-content:center;
      align-items:center;
      gap:6px;
      transition:all .18s ease-out;
      font-size:0.9rem;
    }

    .tab-btn.active{
      color:#000;
      background:linear-gradient(135deg, var(--amarelo-neon), #ffe45c);
      border-color:#000;
      box-shadow:0 0 22px rgba(255,255,0,0.5);
    }

    .section{ display:none; margin-top:4px; }
    .section.active{ display:block; }

    .card{
      background:var(--card-bg);
      border-radius:var(--radius);
      border:1px solid rgba(255,255,255,0.15);
      padding:18px 16px;
      box-shadow:var(--shadow-soft);
    }

    .card h2{
      font-size:1.05rem;
      text-transform:uppercase;
      margin-bottom:8px;
      letter-spacing:0.12em;
    }

    .card p.desc{
      font-size:0.8rem;
      color:var(--cinza);
      margin-bottom:10px;
    }

    .form-row{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      margin-bottom:10px;
    }

    .field{
      flex:1 1 160px;
      min-width:140px;
      display:flex;
      flex-direction:column;
      gap:4px;
      font-size:0.85rem;
    }

    .field label{
      text-transform:uppercase;
      font-size:0.75rem;
      color:var(--cinza);
      letter-spacing:0.12em;
    }

    .field input,
    .field select{
      border-radius:999px;
      border:1px solid rgba(255,255,255,0.25);
      background:rgba(0,0,0,0.85);
      color:var(--amarelo-neon);
      padding:7px 11px;
      font-size:0.9rem;
      outline:none;
      text-align:left;
    }

    .field input:focus,
    .field select:focus{
      border-color:var(--amarelo-neon);
      box-shadow:0 0 0 1px rgba(255,255,0,0.35);
    }

    .grupo-titulo{
      margin-top:12px;
      margin-bottom:4px;
      padding-top:8px;
      border-top:1px solid rgba(255,255,255,0.16);
      font-size:0.86rem;
      color:var(--cinza);
      text-transform:uppercase;
      letter-spacing:0.14em;
    }

    .readonly-value{
      background:rgba(5,5,5,0.95);
    }

    .form-actions{
      margin-top:10px;
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      justify-content:flex-end;
    }

    .btn{
      border-radius:999px;
      padding:8px 16px;
      border:1px solid rgba(255,255,255,0.3);
      text-transform:uppercase;
      cursor:pointer;
      letter-spacing:0.16em;
      background:radial-gradient(circle at top, rgba(255,255,255,0.12), rgba(0,0,0,0.92));
      color:var(--amarelo-neon);
      display:inline-flex;
      align-items:center;
      gap:6px;
      font-size:0.78rem;
    }

    .btn.primary{
      background:linear-gradient(135deg, var(--amarelo-neon), #ffd94a);
      color:#000;
      border-color:#000;
      box-shadow:0 0 16px rgba(255,255,0,0.55);
    }

    .btn.danger{
      color:#ff8080;
      border-color:#990000;
    }

    .btn.small{
      padding:4px 10px;
      font-size:0.7rem;
      letter-spacing:0.08em;
    }

    .alert{
      margin-top:8px;
      font-size:0.8rem;
      padding:6px 10px;
      border-radius:10px;
      border:1px solid rgba(255,255,255,0.18);
      background:rgba(0,0,0,0.7);
      display:none;
    }

    .alert.ok{
      border-color:#4caf50;
      color:#bdfcbf;
    }

    .alert.error{
      border-color:#f44336;
      color:#ffc1c1;
    }

    .filters{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      margin-bottom:10px;
      align-items:flex-end;
    }

    table{
      width:100%;
      border-collapse:collapse;
      margin-top:8px;
      font-size:0.78rem;
    }

    thead{ background:rgba(255,255,255,0.06); }

    th,td{
      padding:5px 4px;
      border-bottom:1px solid rgba(255,255,255,0.08);
      text-align:center;
      white-space:nowrap;
    }

    .muted{
      color:var(--cinza-medio);
      font-size:0.78rem;
      margin-top:6px;
    }

    /* ===================== MOBILE ‚Äì ESPA√áAMENTO M√çNIMO ===================== */
    @media (max-width:720px){

      body{
        padding:4px !important;
      }

      .shell{
        padding:6px 4px !important;
        border-radius:16px !important;
      }

      header{
        flex-direction:column;
        gap:1px !important;
        margin-bottom:2px !important;
        padding-bottom:2px !important;
      }

      .titulo{ font-size:1.05rem !important; }
      .subtitulo{ font-size:0.72rem !important; }

      .badge{
        font-size:0.7rem !important;
        padding:2px 8px !important;
        margin-top:1px !important;
      }

      .tabs-top{
        flex-direction:column;
        gap:2px !important;
        margin-bottom:3px !important;
      }

      .tab-btn{
        padding:5px 8px !important;
        font-size:0.78rem !important;
        letter-spacing:0.12em !important;
      }

      .section{
        margin-top:0 !important;
      }

      .card{
        padding:6px 4px !important;
      }

      .card h2{
        font-size:0.9rem !important;
        margin:0 0 2px 0 !important;
      }

      .card p.desc{
        font-size:0.72rem !important;
        margin:0 0 3px 0 !important;
      }

      /* ---------- FORMUL√ÅRIO E RESUMO: LINHAS E CAMPOS SEM ESPA√áO ---------- */
      .form-row{
        flex-direction:column !important;
        gap:0 !important;
        margin:0 !important;
        padding:0 !important;
      }

      .field{
        min-width:100% !important;
        margin:0 !important;
        padding:0 !important;
        gap:0 !important;
      }

      .field label{
        font-size:0.62rem !important;
        letter-spacing:0.08em !important;
        margin:0 0 1px 0 !important;
        padding:0 !important;
      }

      .field input,
      .field select{
        padding:3px 8px !important;
        height:24px !important;
        font-size:0.76rem !important;
        margin:0 !important;
      }

      .grupo-titulo{
        margin:4px 0 1px 0 !important;
        padding:0 !important;
        font-size:0.72rem !important;
      }

      .form-actions{
        margin:4px 0 0 0 !important;
        padding:0 !important;
        gap:4px !important;
        flex-direction:column !important;
      }

      .btn{
        width:100% !important;
        justify-content:center;
        padding:6px 8px !important;
        font-size:0.72rem !important;
      }

      /* ---------- FILTROS VISUALIZAR ---------- */
      .filters{
        gap:0 !important;
        margin:0 0 4px 0 !important;
      }

      .filters .field{
        min-width:100% !important;
        margin:0 0 2px 0 !important;
      }

      th,td{
        font-size:0.68rem !important;
        padding:2px !important;
      }

      h3{
        margin:4px 0 2px 0 !important;
        font-size:0.8rem !important;
      }

      .muted{
        margin-top:2px !important;
        font-size:0.7rem !important;
      }

      /* ---------- RESUMO DOS INDICADORES ‚Äì REFOR√áO ---------- */
      #resumoCampos .form-row{
        flex-direction:column !important;
        gap:0 !important;
        margin:0 !important;
        padding:0 !important;
      }

      #resumoCampos .field{
        min-width:100% !important;
        margin:0 !important;
        padding:0 !important;
        gap:0 !important;
      }

      #resumoCampos .field label{
        margin:0 0 1px 0 !important;
        font-size:0.62rem !important;
      }

      #resumoCampos .field input{
        margin:0 !important;
        padding:2px 8px !important;
        height:22px !important;
        font-size:0.75rem !important;
      }

      #resumoCampos .grupo-titulo{
        margin:4px 0 1px 0 !important;
        padding:0 !important;
      }
    }
  </style>
</head>
<body>
  <div class="shell">
    <div class="shell-inner">
      <header>
        <div>
          <div class="titulo">Sistema de Resultados Operacionais</div>
          <div class="subtitulo">2¬™ Companhia - 18¬∫ BPM/I</div>
        </div>
        <div class="badge">Uso interno ‚Ä¢ Lan√ßamento &amp; Resumo</div>
      </header>

      <div class="tabs-top">
        <button class="tab-btn active" data-target="form">‚úèÔ∏è Lan√ßar Resultado</button>
        <button class="tab-btn" data-target="view">üìä Visualizar Resultados</button>
      </div>

      <!-- ===================== FORMUL√ÅRIO ===================== -->
      <section id="form" class="section active">
        <div class="card">
          <h2 id="tituloForm">Lan√ßamento de Resultados</h2>
          <p class="desc" id="descForm">
            Preencha os dados da opera√ß√£o e lance os resultados da viatura.
          </p>

          <div id="editBanner" class="alert ok"></div>

          <form id="formLancamento">
            <div class="form-row">
              <div class="field">
                <label for="dataOperacao">Data da opera√ß√£o</label>
                <input type="date" id="dataOperacao" name="dataOperacao">
              </div>
              <div class="field">
                <label for="cidade">Cidade</label>
                <select id="cidade" name="cidade" required>
                  <option value="">Selecione...</option>
                  <option>Martin√≥polis</option>
                  <option>Rancharia</option>
                  <option>Jo√£o Ramalho</option>
                  <option>Caiabu</option>
                  <option>Indiana</option>
                  <option>Taciba</option>
                  <option>Nantes</option>
                  <option>Iep√™</option>
                </select>
              </div>
            </div>

            <div class="form-row">
              <div class="field">
                <label for="viatura">Viatura</label>
                <input type="text" id="viatura" name="viatura" placeholder="Ex: M-18210" required>
              </div>
              <div class="field">
                <label for="re">RE</label>
                <input type="text" id="re" name="re" placeholder="RE do respons√°vel" required>
              </div>
            </div>

            <div id="camposNumericos"></div>

            <div class="form-actions">
              <button type="button" class="btn danger" id="btnLimpar">
                Limpar / Sair da edi√ß√£o
              </button>
              <button type="submit" class="btn primary" id="btnSalvar">
                Salvar lan√ßamento
              </button>
            </div>

            <div id="alertForm" class="alert"></div>
          </form>
        </div>
      </section>

      <!-- ===================== VISUALIZA√á√ÉO ===================== -->
      <section id="view" class="section">
        <div class="card">
          <h2>Visualiza√ß√£o de Resultados</h2>
          <p class="desc">
            Filtre por data e, se desejar, por munic√≠pio. Abaixo voc√™ pode editar lan√ßamentos por viatura.
          </p>

          <div class="filters">
            <div class="field" style="max-width:220px;">
              <label for="dataResumo">Data</label>
              <input type="date" id="dataResumo">
            </div>
            <div class="field" style="max-width:260px;">
              <label for="cidadeResumo">Munic√≠pio / Companhia</label>
              <select id="cidadeResumo">
                <option value="">Toda 2¬™ Companhia</option>
                <option>Martin√≥polis</option>
                <option>Rancharia</option>
                <option>Jo√£o Ramalho</option>
                <option>Caiabu</option>
                <option>Indiana</option>
                <option>Taciba</option>
                <option>Nantes</option>
                <option>Iep√™</option>
              </select>
            </div>
            <button class="btn" id="btnAtualizarResumo">Atualizar resumo</button>
          </div>

          <div id="semDadosResumo" class="muted">
            Nenhum lan√ßamento encontrado para o filtro selecionado.
          </div>

          <div id="tabelasResumo" style="display:none;">
            <h3 style="font-size:0.9rem;margin-top:4px;">Resumo dos indicadores</h3>
            <div id="resumoCampos"></div>

            <h3 style="font-size:0.9rem;margin-top:12px;">Lan√ßamentos detalhados (por viatura)</h3>
            <p class="muted">Clique em <strong>Editar</strong> para ajustar um lan√ßamento.</p>
            <div style="overflow-x:auto;">
              <table id="tabelaDetalhes"></table>
            </div>
          </div>
        </div>
      </section>
    </div>
  </div>

  <script>
    const DB_URL = "https://resultados-1c75f-default-rtdb.firebaseio.com";

    let editingKey = null;
    let editingLancamento = null;

    const GRUPOS = [
      {
        titulo: "Dados B√°sicos",
        campos: [
          { id: "pessoas_abordadas_exceto_condutores", label: "Pessoas abordadas (exceto condutores)" },
          { id: "bopm_lavrados", label: "Quantidade de BOPM Lavrados" },
          { id: "mandados_busca_apreensao_cumpridos", label: "Mandados Busca e Apreens√£o cumpridos" }
        ]
      },
      {
        titulo: "Flagrantes / Pessoas",
        campos: [
          { id: "ato_infracional", label: "Ato Infracional" },
          { id: "crime_exceto_trafico", label: "Crime (Exceto Tr√°fico)" },
          { id: "trafico_drogas", label: "Tr√°fico Drogas" },
          { id: "pessoas_presas", label: "Pessoas Presas" },
          { id: "adolescentes_sindicados", label: "Adolescentes Sindicados" },
          { id: "adolescentes_apreendidos", label: "Adolescentes Apreendidos" },
          { id: "procurados", label: "Procurados" }
        ]
      },
      {
        titulo: "Drogas (em quilogramas)",
        campos: [
          { id: "cocaina_kg", label: "Coca√≠na (kg)", step: "0.01" },
          { id: "crack_kg", label: "Crack (kg)", step: "0.01" },
          { id: "maconha_kg", label: "Maconha (kg)", step: "0.01" },
          { id: "outra_droga_kg", label: "Outra (kg)", step: "0.01" }
        ]
      },
      {
        titulo: "Material B√©lico",
        campos: [
          { id: "arma_branca", label: "Arma Branca" },
          { id: "arma_fogo_calibre_permitido", label: "Arma de Fogo de calibre permitido" },
          { id: "municao_calibre_permitido", label: "Muni√ß√£o de calibre permitido" },
          { id: "municao_calibre_restrito", label: "Muni√ß√£o de calibre restrito" },
          { id: "revolver_calibre_restrito", label: "Rev√≥lver de calibre restrito" },
          { id: "pistola_calibre_restrito", label: "Pistola de calibre restrito" },
          { id: "outra_arma_fogo", label: "Outra arma de fogo" }
        ]
      },
      {
        titulo: "Apreens√µes Diversas",
        campos: [
          { id: "moeda_reais", label: "Moeda em reais (R$)", step: "0.01" },
          { id: "cigarro_caixas", label: "Cigarro (em caixas)" },
          { id: "celular", label: "Celular" }
        ]
      },
      {
        titulo: "Tr√¢nsito Urbano",
        campos: [
          { id: "acidente_sem_vitima", label: "Acidente de tr√¢nsito sem v√≠tima" },
          { id: "acidente_com_vitima", label: "Acidente de tr√¢nsito com v√≠tima" },
          { id: "vitimas_nao_fatais", label: "V√≠timas n√£o fatais de acidentes de tr√¢nsito" },
          { id: "vitimas_fatais", label: "V√≠timas fatais de acidentes de tr√¢nsito" },
          { id: "total_condutores_abordados", label: "Total de condutores abordados" },
          { id: "autos_infracao_exceto_artigos", label: "Autos de infra√ß√£o - exceto 165, 165-A, 228 e 253-A" },
          { id: "autos_art_165", label: "Autos de infra√ß√£o - Art. 165" },
          { id: "autos_art_165a", label: "Autos de infra√ß√£o - Art. 165-A" },
          { id: "autos_art_228", label: "Autos de infra√ß√£o - Art. 228" },
          { id: "bloqueios_transito", label: "Bloqueios de tr√¢nsito realizados" },
          { id: "pontos_visibilidade", label: "Pontos de visibilidade realizados" },
          { id: "testes_etilometro", label: "Testes de Etil√¥metro realizados" },
          { id: "recusa_etilometro", label: "Recusa dos testes de Etil√¥metro" },
          { id: "flagrantes_art_306", label: "Flagrantes pelo Art. 306 do CTB" },
          { id: "veiculos_auto_vistoriados", label: "Autom√≥veis vistoriados n√£o removidos" },
          { id: "veiculos_moto_vistoriados", label: "Motocicletas vistoriadas n√£o removidas" },
          { id: "veiculos_auto_removidos", label: "Autom√≥veis removidos administrativamente" },
          { id: "veiculos_moto_removidos", label: "Motocicletas removidas administrativamente" },
          { id: "veiculos_auto_ilicito", label: "Autom√≥veis produto de il√≠cito" },
          { id: "veiculos_moto_ilicito", label: "Motocicletas produto de il√≠cito" }
        ]
      }
    ];

    const CAMPOS_MAP = {};
    GRUPOS.forEach(g => g.campos.forEach(c => { CAMPOS_MAP[c.id] = c; }));

    function getTodosCampos(){
      const arr = [];
      GRUPOS.forEach(g => g.campos.forEach(c => arr.push(c)));
      return arr;
    }

    function formatValor(campoId, valor){
      const meta = CAMPOS_MAP[campoId];
      if(meta && meta.step === "0.01"){
        return Number(valor).toFixed(2);
      }
      return String(Math.round(valor));
    }

    function mostrarSection(id){
      document.querySelectorAll(".section").forEach(sec=>{
        sec.classList.toggle("active", sec.id === id);
      });
      document.querySelectorAll(".tab-btn").forEach(btn=>{
        btn.classList.toggle("active", btn.dataset.target === id);
      });
    }

    document.querySelectorAll(".tab-btn").forEach(btn=>{
      btn.addEventListener("click", ()=>mostrarSection(btn.dataset.target));
    });

    function montarCamposNumericos(){
      const container = document.getElementById("camposNumericos");
      container.innerHTML = "";
      let contador = 1;

      GRUPOS.forEach(grupo=>{
        const titulo = document.createElement("div");
        titulo.className = "grupo-titulo";
        titulo.textContent = grupo.titulo;
        container.appendChild(titulo);

        const chunkSize = 2;
        for(let i=0;i<grupo.campos.length;i+=chunkSize){
          const row = document.createElement("div");
          row.className = "form-row";

          grupo.campos.slice(i,i+chunkSize).forEach(c=>{
            const f = document.createElement("div");
            f.className = "field";

            const lbl = document.createElement("label");
            const numStr = String(contador).padStart(2,"0");
            lbl.textContent = `${numStr} - ${c.label}`;
            lbl.htmlFor = "campo_"+c.id;

            const inp = document.createElement("input");
            inp.type = "number";
            inp.min = "0";
            inp.step = c.step || "1";
            inp.id = "campo_"+c.id;
            inp.name = c.id;
            inp.placeholder = "0";

            f.appendChild(lbl);
            f.appendChild(inp);
            row.appendChild(f);
            contador++;
          });

          container.appendChild(row);
        }
      });
    }

    async function firebaseSalvarLancamento(lancamento){
      const url = DB_URL + "/operacoes.json";
      const resp = await fetch(url, {
        method: "POST",
        headers: {"Content-Type":"application/json"},
        body: JSON.stringify(lancamento)
      });
      if(!resp.ok) throw new Error("Erro ao salvar: "+resp.status);
      return resp.json();
    }

    async function firebaseAtualizarLancamento(key, lancamento){
      const url = DB_URL + "/operacoes/" + encodeURIComponent(key) + ".json";
      const resp = await fetch(url, {
        method: "PUT",
        headers:{"Content-Type":"application/json"},
        body: JSON.stringify(lancamento)
      });
      if(!resp.ok) throw new Error("Erro ao atualizar: "+resp.status);
      return resp.json();
    }

    async function firebaseCarregarLancamentos(){
      const url = DB_URL + "/operacoes.json";
      const resp = await fetch(url);
      if(!resp.ok) throw new Error("Erro ao carregar: "+resp.status);
      const data = await resp.json();
      if(!data) return [];
      const lista = [];
      for(const k in data){
        if(Object.prototype.hasOwnProperty.call(data,k)){
          lista.push({ firebaseKey:k, ...data[k] });
        }
      }
      return lista;
    }

    const formLancamento = document.getElementById("formLancamento");
    const alertForm   = document.getElementById("alertForm");
    const btnLimpar   = document.getElementById("btnLimpar");
    const editBanner  = document.getElementById("editBanner");
    const tituloForm  = document.getElementById("tituloForm");
    const descForm    = document.getElementById("descForm");
    const btnSalvar   = document.getElementById("btnSalvar");

    function mostrarAlertaForm(msg, ok=true){
      alertForm.textContent = msg;
      alertForm.classList.remove("ok","error");
      alertForm.classList.add(ok ? "ok" : "error");
      alertForm.style.display = "block";
      setTimeout(()=>alertForm.style.display="none", 4500);
    }

    function ajustarDatasPadrao(){
      const hoje = new Date().toISOString().slice(0,10);
      const d1 = document.getElementById("dataOperacao");
      const d2 = document.getElementById("dataResumo");
      if(d1 && !d1.value) d1.value = hoje;
      if(d2 && !d2.value) d2.value = hoje;
    }

    function limparFormulario(){
      formLancamento.reset();
      ajustarDatasPadrao();
      getTodosCampos().forEach(c=>{
        const inp = document.getElementById("campo_"+c.id);
        if(inp) inp.value = "";
      });
    }

    function preencherFormulario(l){
      document.getElementById("dataOperacao").value = l.dataOperacao || l.data || "";
      document.getElementById("cidade").value       = l.cidade || "";
      document.getElementById("viatura").value      = l.viatura || "";
      document.getElementById("re").value           = l.re || "";
      getTodosCampos().forEach(c=>{
        const inp = document.getElementById("campo_"+c.id);
        if(!inp) return;
        const val = l.campos && l.campos[c.id] != null ? l.campos[c.id] : 0;
        inp.value = val;
      });
    }

    function entrarModoEdicao(l){
      editingKey = l.firebaseKey;
      editingLancamento = l;
      preencherFormulario(l);
      mostrarSection("form");
      window.scrollTo({top:0,behavior:"smooth"});

      editBanner.textContent =
        `Editando lan√ßamento da viatura ${l.viatura || ""} - ${l.cidade || ""} (${l.dataOperacao || l.data || ""}).`;
      editBanner.style.display = "block";

      tituloForm.textContent = "Edi√ß√£o de Lan√ßamento";
      descForm.textContent   = "Ajuste os valores e clique em 'Salvar lan√ßamento' para atualizar.";
      btnSalvar.textContent  = "Atualizar lan√ßamento";
    }

    function sairModoEdicao(){
      editingKey = null;
      editingLancamento = null;
      editBanner.style.display = "none";
      tituloForm.textContent = "Lan√ßamento de Resultados";
      descForm.textContent   = "Preencha os dados da opera√ß√£o e lance os resultados da viatura.";
      btnSalvar.textContent  = "Salvar lan√ßamento";
    }

    formLancamento.addEventListener("submit", async e=>{
      e.preventDefault();

      const dataOperacao = document.getElementById("dataOperacao").value;
      const cidade       = document.getElementById("cidade").value;
      const viatura      = document.getElementById("viatura").value.trim();
      const re           = document.getElementById("re").value.trim();

      if(!dataOperacao || !cidade || !viatura || !re){
        mostrarAlertaForm("Preencha data, cidade, viatura e RE.", false);
        return;
      }

      const campos = {};
      getTodosCampos().forEach(c=>{
        const inp = document.getElementById("campo_"+c.id);
        let v = parseFloat((inp.value || "0").toString().replace(",", "."));
        if(isNaN(v)) v = 0;
        campos[c.id] = v;
      });

      const lanc = {
        dataOperacao,
        cidade,
        viatura,
        re,
        campos,
        criadoEm: editingLancamento && editingLancamento.criadoEm
          ? editingLancamento.criadoEm
          : new Date().toISOString()
      };

      try{
        if(editingKey){
          await firebaseAtualizarLancamento(editingKey, lanc);
          mostrarAlertaForm("Lan√ßamento atualizado com sucesso!", true);
          sairModoEdicao();
        }else{
          await firebaseSalvarLancamento(lanc);
          mostrarAlertaForm("Lan√ßamento salvo com sucesso!", true);
        }
        limparFormulario();
      }catch(err){
        console.error(err);
        mostrarAlertaForm("Erro ao salvar no Firebase.", false);
      }
    });

    btnLimpar.addEventListener("click", ()=>{
      limparFormulario();
      if(editingKey) sairModoEdicao();
    });

    const dataResumoInput      = document.getElementById("dataResumo");
    const cidadeResumoSelect   = document.getElementById("cidadeResumo");
    const btnAtualizarResumo   = document.getElementById("btnAtualizarResumo");
    const semDadosResumo       = document.getElementById("semDadosResumo");
    const tabelasResumo        = document.getElementById("tabelasResumo");
    const resumoCampos         = document.getElementById("resumoCampos");
    const tabelaDetalhes       = document.getElementById("tabelaDetalhes");

    function montarResumoIndicadores(mapa){
      resumoCampos.innerHTML = "";
      let contador = 1;
      GRUPOS.forEach(grupo=>{
        const titulo = document.createElement("div");
        titulo.className = "grupo-titulo";
        titulo.textContent = grupo.titulo;
        resumoCampos.appendChild(titulo);

        const chunkSize = 2;
        for(let i=0;i<grupo.campos.length;i+=chunkSize){
          const row = document.createElement("div");
          row.className = "form-row";

          grupo.campos.slice(i,i+chunkSize).forEach(c=>{
            const f = document.createElement("div");
            f.className = "field";

            const lbl = document.createElement("label");
            const numStr = String(contador).padStart(2,"0");
            lbl.textContent = `${numStr} - ${c.label}`;
            lbl.htmlFor = "resumo_"+c.id;

            const inp = document.createElement("input");
            inp.type = "text";
            inp.readOnly = true;
            inp.className = "readonly-value";
            inp.id = "resumo_"+c.id;
            const val = mapa[c.id] != null ? mapa[c.id] : 0;
            inp.value = formatValor(c.id, val);

            f.appendChild(lbl);
            f.appendChild(inp);
            row.appendChild(f);
            contador++;
          });

          resumoCampos.appendChild(row);
        }
      });
    }

    async function atualizarResumo(){
      const data         = dataResumoInput.value;
      const cidadeFiltro = cidadeResumoSelect.value;

      if(!data){
        semDadosResumo.textContent = "Selecione uma data para visualizar o resumo.";
        semDadosResumo.style.display = "block";
        tabelasResumo.style.display  = "none";
        return;
      }

      let lancamentos;
      try{
        const todos = await firebaseCarregarLancamentos();
        lancamentos = todos.filter(l => l.dataOperacao === data);
      }catch(err){
        console.error(err);
        semDadosResumo.textContent = "Erro ao carregar dados do Firebase.";
        semDadosResumo.style.display = "block";
        tabelasResumo.style.display  = "none";
        return;
      }

      if(cidadeFiltro){
        lancamentos = lancamentos.filter(l => l.cidade === cidadeFiltro);
      }

      if(lancamentos.length === 0){
        semDadosResumo.textContent = "Nenhum lan√ßamento encontrado para o filtro.";
        semDadosResumo.style.display = "block";
        tabelasResumo.style.display  = "none";
        return;
      }

      semDadosResumo.style.display = "none";
      tabelasResumo.style.display  = "block";

      const todosCampos = getTodosCampos();
      const mapa = {};
      todosCampos.forEach(c=>mapa[c.id]=0);

      lancamentos.forEach(l=>{
        todosCampos.forEach(c=>{
          const v = parseFloat(l.campos && l.campos[c.id] != null ? l.campos[c.id] : 0) || 0;
          mapa[c.id] += v;
        });
      });

      montarResumoIndicadores(mapa);

      tabelaDetalhes.innerHTML = "";
      const thead = document.createElement("thead");
      const trh   = document.createElement("tr");

      ["Editar","Data","Munic√≠pio","Viatura","RE"].forEach(t=>{
        const th = document.createElement("th");
        th.textContent = t;
        trh.appendChild(th);
      });
      todosCampos.forEach(c=>{
        const th = document.createElement("th");
        th.textContent = c.label;
        trh.appendChild(th);
      });
      thead.appendChild(trh);
      tabelaDetalhes.appendChild(thead);

      const tbody = document.createElement("tbody");
      lancamentos.forEach(l=>{
        const tr = document.createElement("tr");

        const tdEdit = document.createElement("td");
        const btnE   = document.createElement("button");
        btnE.type    = "button";
        btnE.className = "btn small";
        btnE.textContent = "Editar";
        btnE.addEventListener("click", ()=>entrarModoEdicao(l));
        tdEdit.appendChild(btnE);
        tr.appendChild(tdEdit);

        const colsBase = [l.dataOperacao || "", l.cidade || "", l.viatura || "", l.re || ""];
        colsBase.forEach(v=>{
          const td = document.createElement("td");
          td.textContent = v;
          tr.appendChild(td);
        });

        todosCampos.forEach(c=>{
          const td = document.createElement("td");
          const v  = parseFloat(l.campos && l.campos[c.id] != null ? l.campos[c.id] : 0) || 0;
          td.textContent = formatValor(c.id, v);
          tr.appendChild(td);
        });

        tbody.appendChild(tr);
      });
      tabelaDetalhes.appendChild(tbody);
    }

    btnAtualizarResumo.addEventListener("click", atualizarResumo);
    dataResumoInput.addEventListener("change", atualizarResumo);
    cidadeResumoSelect.addEventListener("change", atualizarResumo);

    document.addEventListener("DOMContentLoaded", ()=>{
      montarCamposNumericos();
      ajustarDatasPadrao();
      mostrarSection("form");
    });
  </script>
</body>
</html>
